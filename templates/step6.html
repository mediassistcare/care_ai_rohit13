{% extends "base.html" %}

{% block title %}Detailed Analysis - Step 6 - Care Diagnostics{% endblock %}

{% block content %}
<div class="step-container">
    <div class="step-header">
        <h2><i class="fas fa-search-plus"></i> Step 6: Detailed Symptom Analysis</h2>
        <p>Comprehensive AI analysis of your symptoms with personalized questions and medical correlations</p>
        <div class="progress-bar">
            <div class="progress-fill" style="width: 100%"></div>
        </div>
    </div>

    <div class="analysis-container">
        <!-- Loading State -->
        <div class="analysis-status" id="analysis-status">
            <div class="status-message">
                <i class="fas fa-brain fa-spin fa-2x"></i>
                <h3>Performing Detailed Analysis</h3>
                <p>Our AI is analyzing your symptoms, correlating with your vitals, and generating personalized questions...</p>
            </div>
        </div>

        <!-- Analysis Results -->
        <div class="analysis-results" id="analysis-results" style="display: none;">
            
            <!-- Correlated Questions Section -->
            <div class="analysis-section">
                <h3><i class="fas fa-question-circle"></i> Personalized Diagnostic Questions</h3>
                <p class="section-description">Answer these targeted questions to help refine your diagnosis</p>
                <div id="correlated-questions"></div>
                
                <div class="questions-progress" id="questions-progress" style="display: none;">
                    <div class="progress-header">
                        <span>Progress: <span id="answered-count">0</span> of <span id="total-questions">0</span> questions answered</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                    </div>
                </div>

                <div class="questions-actions" id="questions-actions" style="display: none;">
                    <button type="button" class="btn-secondary" onclick="skipQuestions()">
                        Skip Questions
                    </button>
                    <button type="button" class="btn-primary" id="submit-responses" onclick="submitResponses()">
                        Submit Responses <i class="fas fa-check"></i>
                    </button>
                </div>
            </div>

            <!-- Navigation Actions -->
            <div class="navigation-actions" id="navigation-actions" style="display: none;">
                <button type="button" class="btn-secondary" onclick="window.location.href='/step5'">
                    <i class="fas fa-arrow-left"></i> Back to Symptoms
                </button>
                <button type="button" class="btn-primary" onclick="completeAnalysis()" id="complete-analysis">
                    Complete Analysis <i class="fas fa-check"></i>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentAnalysis = null;
let questionResponses = {};
let totalQuestions = 0;

document.addEventListener('DOMContentLoaded', function() {
    // Start detailed analysis immediately when page loads
    performDetailedAnalysis();
});

function performDetailedAnalysis() {
    fetch('/analyze_complaints', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentAnalysis = data.analysis;
            displayAnalysisResults(data.analysis);
        } else {
            showError(data.error || 'Failed to perform analysis');
        }
    })
    .catch(error => {
        showError('Error: ' + error.message);
    });
}

function displayAnalysisResults(analysis) {
    const analysisStatus = document.getElementById('analysis-status');
    const analysisResults = document.getElementById('analysis-results');
    
    analysisStatus.style.display = 'none';
    analysisResults.style.display = 'block';
    
    // Display correlated questions
    displayCorrelatedQuestions(analysis.correlated_questions || []);
}

function displayCorrelatedQuestions(questions) {
    const container = document.getElementById('correlated-questions');
    
    if (questions.length === 0) {
        container.innerHTML = '<p class="no-data">No additional questions needed.</p>';
        showNavigationActions();
        return;
    }
    
    totalQuestions = questions.length;
    document.getElementById('total-questions').textContent = totalQuestions;
    
    let html = '<div class="questions-container">';
    questions.forEach((question, index) => {
        html += `
            <div class="question-card">
                <div class="question-header">
                    <div class="question-number">${index + 1}</div>
                    <div class="question-content">
                        <div class="question-text">${question.question}</div>
                        <div class="question-category">
                            <span class="category-badge category-${question.category}">${question.category.replace('_', ' ')}</span>
                        </div>
                    </div>
                </div>
                <div class="answer-options" id="options-${index}">
        `;
        
        if (question.type === 'multiple_choice' && question.options) {
            question.options.forEach((option, optIndex) => {
                html += `
                    <label class="answer-option">
                        <input type="radio" name="question-${index}" value="${option}" 
                               onchange="recordAnswer(${index}, '${option}')">
                        <div class="option-content">
                            <div class="option-text">${option}</div>
                        </div>
                    </label>
                `;
            });
        } else if (question.type === 'text') {
            html += `
                <div class="text-answer">
                    <textarea name="question-${index}" placeholder="Please describe..." 
                              onchange="recordAnswer(${index}, this.value)" 
                              rows="3" class="form-control"></textarea>
                </div>
            `;
        } else if (question.type === 'number') {
            html += `
                <div class="number-answer">
                    <input type="number" name="question-${index}" placeholder="Enter value..." 
                           onchange="recordAnswer(${index}, this.value)" 
                           class="form-control">
                </div>
            `;
        }
        
        html += `
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    container.innerHTML = html;
    
    // Show progress and actions
    document.getElementById('questions-progress').style.display = 'block';
    document.getElementById('questions-actions').style.display = 'flex';
}

function recordAnswer(questionIndex, value) {
    questionResponses[questionIndex] = {
        question: currentAnalysis.correlated_questions[questionIndex].question,
        category: currentAnalysis.correlated_questions[questionIndex].category,
        answer_value: value,
        timestamp: new Date().toISOString()
    };
    
    updateProgress();
}

function updateProgress() {
    const answeredQuestions = Object.keys(questionResponses).length;
    const progressPercent = (answeredQuestions / totalQuestions) * 100;
    
    document.getElementById('answered-count').textContent = answeredQuestions;
    document.getElementById('progress-fill').style.width = progressPercent + '%';
    
    const submitButton = document.getElementById('submit-responses');
    // Keep button enabled at all times
    submitButton.disabled = false;
    
    if (answeredQuestions === totalQuestions) {
        submitButton.innerHTML = 'Submit Responses <i class="fas fa-check"></i>';
    } else {
        submitButton.innerHTML = `Submit Responses (${answeredQuestions}/${totalQuestions} answered) <i class="fas fa-check"></i>`;
    }
}

function submitResponses() {
    console.log('submitResponses called, questionResponses:', questionResponses);
    
    // Prepare complete data with questions and responses
    const completeData = {
        responses: questionResponses,
        original_questions: currentAnalysis.correlated_questions,
        analysis_data: {
            total_questions_generated: totalQuestions,
            questions_answered: Object.keys(questionResponses).length,
            completion_timestamp: new Date().toISOString()
        }
    };
    
    fetch('/save_question_responses', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(completeData)
    })
    .then(response => response.json())
    .then(data => {
        console.log('Save responses result:', data);
        if (data.success) {
            console.log('Response saved successfully, checking for summary...');
            console.log('show_summary:', data.show_summary);
            console.log('clinical_summary length:', data.clinical_summary ? data.clinical_summary.length : 'undefined');
            
            if (data.show_summary && data.clinical_summary) {
                console.log('Showing clinical summary popup...');
                showClinicalSummaryPopup(data.clinical_summary);
            } else {
                console.log('No summary to show or error generating summary, displaying success message...');
                showResponsesSubmitted();
                // Show completion message instead of redirecting to report
                setTimeout(() => {
                    alert('Assessment completed successfully! Thank you for providing your information.');
                    window.location.href = '/';
                }, 3000);
            }
        } else {
            alert('Error saving responses: ' + data.error);
            console.error('Save responses error:', data);
        }
    })
    .catch(error => {
        console.error('Network error:', error);
        alert('Error: ' + error.message);
    });
}

function skipQuestions() {
    const confirmed = confirm('Are you sure you want to skip these questions? Answering them helps improve diagnostic accuracy.');
    if (confirmed) {
        showQuestionsSkipped();
        // Auto-redirect to home after 2 seconds since step7 is removed
        setTimeout(() => {
            window.location.href = '/';
        }, 2000);
    }
}

function showClinicalSummaryPopup(clinicalSummary) {
    console.log('showClinicalSummaryPopup called with:', clinicalSummary ? clinicalSummary.length + ' characters' : 'empty summary');
    
    // Create popup overlay
    const overlay = document.createElement('div');
    overlay.className = 'clinical-summary-overlay';
    overlay.innerHTML = `
        <div class="clinical-summary-modal">
            <div class="summary-header">
                <h3><i class="fas fa-file-medical-alt"></i> Clinical Summary</h3>
                <button class="close-btn" onclick="closeSummaryPopup()">&times;</button>
            </div>
            <div class="summary-content">
                <div class="summary-text">
                    ${clinicalSummary ? clinicalSummary.replace(/\n/g, '<br>') : 'Clinical summary not available.'}
                </div>
            </div>
            <div class="summary-actions">
                <button class="btn-secondary" onclick="closeSummaryPopup()">Close</button>
                <button class="btn-primary" onclick="completeSummaryReview()">
                    Complete Assessment <i class="fas fa-check"></i>
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(overlay);
    console.log('Clinical summary popup added to DOM');
    
    // Add event listener for overlay click to close
    overlay.addEventListener('click', function(e) {
        if (e.target === overlay) {
            closeSummaryPopup();
        }
    });
}

function closeSummaryPopup() {
    const overlay = document.querySelector('.clinical-summary-overlay');
    if (overlay) {
        overlay.remove();
    }
}

function proceedToReport() {
    closeSummaryPopup();
    window.location.href = '/report';
}

function completeSummaryReview() {
    // Get the clinical summary text from the popup
    const summaryTextElement = document.querySelector('.summary-text');
    const clinicalSummary = summaryTextElement ? summaryTextElement.textContent.replace(/<br>/g, '\n') : '';
    
    if (!clinicalSummary || clinicalSummary.trim() === '') {
        console.error('No clinical summary found to save');
        closeSummaryPopup();
        alert('Proceeding to ICD11 code generation...');
        setTimeout(() => {
            window.location.href = '/step7';
        }, 1000);
        return;
    }
    
    console.log('Saving clinical summary and proceeding to step 7...', clinicalSummary.length, 'characters');
    
    // Save the clinical summary to storage
    fetch('/save_clinical_summary', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            clinical_summary: clinicalSummary
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Clinical summary saved successfully:', data);
            closeSummaryPopup();
            alert('Clinical summary saved! Proceeding to ICD11 code generation...');
            setTimeout(() => {
                window.location.href = '/step7';
            }, 1000);
        } else {
            console.error('Error saving clinical summary:', data.error);
            closeSummaryPopup();
            alert('There was an issue saving the summary, but proceeding to ICD11 generation: ' + data.error);
            setTimeout(() => {
                window.location.href = '/step7';
            }, 1000);
        }
    })
    .catch(error => {
        console.error('Network error saving clinical summary:', error);
        closeSummaryPopup();
        alert('Network error saving the summary, but proceeding to ICD11 generation.');
        setTimeout(() => {
            window.location.href = '/step7';
        }, 1000);
    });
}

function showResponsesSubmitted() {
    const container = document.getElementById('correlated-questions');
    container.innerHTML = `
        <div class="responses-submitted">
            <div class="success-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h4>Responses Submitted Successfully</h4>
            <p>Thank you for providing detailed information. Your responses will enhance diagnostic accuracy.</p>
            <p class="redirect-message">
                <i class="fas fa-arrow-right"></i> 
                Proceeding to report in 2 seconds...
            </p>
        </div>
    `;
    document.getElementById('questions-progress').style.display = 'none';
    document.getElementById('questions-actions').style.display = 'none';
}

function showQuestionsSkipped() {
    const container = document.getElementById('correlated-questions');
    container.innerHTML = `
        <div class="questions-skipped">
            <div class="skip-icon">
                <i class="fas fa-forward"></i>
            </div>
            <h4>Questions Skipped</h4>
            <p>Analysis will proceed based on your current symptom information.</p>
            <p class="redirect-message">
                <i class="fas fa-arrow-right"></i> 
                Proceeding to final diagnosis and ICD codes in 2 seconds...
            </p>
        </div>
    `;
    document.getElementById('questions-progress').style.display = 'none';
    document.getElementById('questions-actions').style.display = 'none';
}

function showNavigationActions() {
    document.getElementById('navigation-actions').style.display = 'flex';
}

function handleImageUpload(index, imageType) {
    const fileInput = document.getElementById(`file-${index}`);
    const file = fileInput.files[0];
    
    if (!file) return;
    
    const formData = new FormData();
    formData.append('medical_image', file);
    formData.append('image_type', imageType);
    formData.append('description', `Uploaded ${imageType} for symptom analysis`);
    
    fetch('/upload_medical_image', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Medical image uploaded successfully!');
        } else {
            alert('Upload failed: ' + data.error);
        }
    })
    .catch(error => {
        alert('Upload error: ' + error.message);
    });
}

function completeAnalysis() {
    window.location.href = '/step7';
}

function showError(message) {
    document.getElementById('analysis-status').innerHTML = `
        <div class="status-message error">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Analysis Error</h3>
            <p>${message}</p>
            <button type="button" class="btn-primary" onclick="window.location.href='/step5'">
                Return to Step 5
            </button>
        </div>
    `;
}
</script>

<style>
/* Interactive Clinical Questions */
.clinical-question-preview {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    opacity: 0.8;
}

.btn-interactive {
    background: #3498db;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 6px;
    font-weight: 500;
    margin-top: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-interactive:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
}

.answerable-question {
    background: #fff;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    transition: border-color 0.3s ease;
}

.answerable-question:hover {
    border-color: #3498db;
}

.answerable-question.answered {
    border-color: #28a745;
    background: #f8fff8;
}

.interactive-intro {
    color: #6c757d;
    margin-bottom: 20px;
    font-style: italic;
}

.answer-section {
    margin-top: 15px;
}

.answer-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 5px;
    margin-top: 6px;
}

/* Force more columns on all screen sizes */
@media (min-width: 480px) {
    .answer-options {
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    }
}

/* Responsive grid for wider screens */
@media (min-width: 768px) {
    .answer-options {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 6px;
    }
}

@media (min-width: 1024px) {
    .answer-options {
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 8px;
    }
}

.answer-option {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: #ffffff;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 1px 2px rgba(0,0,0,0.03);
    font-size: 13px;
}

.answer-option:hover {
    border-color: #3498db;
    background: #f8fbff;
    box-shadow: 0 1px 4px rgba(52, 152, 219, 0.1);
}

.answer-option input[type="radio"] {
    margin: 0;
    transform: scale(1.1);
    accent-color: #3498db;
}

.answer-option input[type="radio"]:checked {
    accent-color: #28a745;
}

.answer-option:has(input:checked) {
    border-color: #28a745;
    background: #f8fff8;
    box-shadow: 0 1px 6px rgba(40, 167, 69, 0.12);
}

.option-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.option-text {
    font-weight: 500;
    color: #2c3e50;
    font-size: 12px;
    line-height: 1.2;
}
}

.option-significance {
    font-size: 0.85em;
    color: #6c757d;
    font-style: italic;
}

.questions-progress {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    margin: 20px 0;
}

.progress-header {
    margin-bottom: 10px;
    font-weight: 500;
    color: #495057;
}

.progress-bar {
    width: 100%;
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    transition: width 0.3s ease;
}

.questions-submit {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 20px;
}

.answers-submitted, .questions-skipped {
    text-align: center;
    padding: 30px;
    background: #f8f9fa;
    border-radius: 12px;
    margin: 20px 0;
}

.responses-submitted, .questions-skipped {
    text-align: center;
    padding: 30px;
    background: #f8f9fa;
    border-radius: 12px;
    margin: 20px 0;
}

.redirect-message {
    margin-top: 20px;
    padding: 15px;
    background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
    color: white;
    border-radius: 8px;
    font-weight: 600;
    animation: pulse 2s infinite;
}

.redirect-message i {
    margin-right: 8px;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}

.success-icon {
    font-size: 3em;
    color: #28a745;
    margin-bottom: 15px;
}

.skip-icon {
    font-size: 3em;
    color: #6c757d;
    margin-bottom: 15px;
}

.answers-summary {
    text-align: left;
    background: #fff;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    margin-top: 20px;
}

.answers-summary h5 {
    color: #3498db;
    margin-bottom: 15px;
}

.answers-summary ul {
    list-style: none;
    padding: 0;
}

.answers-summary li {
    padding: 10px;
    border-bottom: 1px solid #e9ecef;
    margin-bottom: 10px;
}

.answers-summary li:last-child {
    border-bottom: none;
}

/* Interactive Assessment */
.interactive-assessment {
    background: #fff;
    border: 2px solid #3498db;
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
}

.assessment-header h4 {
    color: #3498db;
    margin-bottom: 10px;
}

.assessment-intro {
    color: #6c757d;
    margin-bottom: 20px;
    font-style: italic;
}

.interactive-question {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
}

.question-header {
    display: flex;
    align-items: flex-start;
    margin-bottom: 15px;
}

.answer-options {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-left: 40px;
}

.option-label {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px;
    background: #fff;
    border: 2px solid #e9ecef;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.option-label:hover {
    border-color: #3498db;
    background: #f0f8ff;
}

.option-label input[type="radio"]:checked + .option-text {
    font-weight: bold;
    color: #3498db;
}

.option-label input[type="radio"] {
    margin: 0;
}

.option-text {
    flex: 1;
    font-weight: 500;
}

.option-significance {
    font-size: 0.8em;
    color: #6c757d;
    font-style: italic;
}

.assessment-actions {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 20px;
}

.assessment-complete {
    text-align: center;
    padding: 30px;
}

.complete-icon {
    font-size: 3em;
    color: #28a745;
    margin-bottom: 15px;
}

.assessment-complete h4 {
    color: #28a745;
    margin-bottom: 10px;
}

/* Navigation button states */
#proceed-to-step6:disabled {
    background: #6c757d !important;
    cursor: not-allowed;
    opacity: 0.6;
}

/* Concise label display */
.labels-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
}

.label-chip {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 0.9em;
    font-weight: 500;
}

.label-chip.primary {
    background: #3498db;
    color: white;
}

.label-chip.secondary {
    background: #e9ecef;
    color: #495057;
    border: 1px solid #dee2e6;
}

.label-chip i {
    font-size: 0.8em;
}

/* Correlation summary */
.correlation-summary {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
}

.correlation-item {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
    flex-wrap: wrap;
}

.feature-name {
    background: #e3f2fd;
    color: #1976d2;
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: 500;
    font-size: 0.9em;
}

.arrow {
    color: #6c757d;
    font-weight: bold;
}

.associated-labels {
    color: #495057;
    font-style: italic;
}

.strength-badge {
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.75em;
    font-weight: bold;
}

.strength-strong {
    background: #28a745;
    color: white;
}

.strength-moderate {
    background: #ffc107;
    color: #212529;
}

.strength-weak {
    background: #6c757d;
    color: white;
}

.diagnostic-note {
    font-size: 0.85em;
    color: #6c757d;
    font-style: italic;
    margin-top: 5px;
}

/* Clinical questions */
.questions-intro, .pattern-intro {
    font-size: 0.95em;
    color: #6c757d;
    margin-bottom: 15px;
    font-style: italic;
}

.clinical-question {
    display: flex;
    background: #fff;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    align-items: flex-start;
}

.question-number {
    background: #3498db;
    color: white;
    width: 25px;
    height: 25px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.8em;
    margin-right: 15px;
    flex-shrink: 0;
}

.question-content {
    flex: 1;
}

.question-text {
    font-weight: 500;
    margin-bottom: 8px;
    color: #343a40;
}

.question-rationale {
    font-size: 0.85em;
    color: #6c757d;
    display: flex;
    align-items: center;
    gap: 5px;
}

.question-rationale i {
    color: #ffc107;
}

/* Pattern indicators */
.pattern-indicator {
    background: #e8f5e8;
    border: 1px solid #c3e6cb;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
}

.pattern-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    flex-wrap: wrap;
    gap: 10px;
}

.symptom-pair {
    font-weight: bold;
    color: #155724;
}

.correlation-type {
    background: #28a745;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8em;
    text-transform: capitalize;
}

.clinical-significance {
    margin-bottom: 8px;
    font-size: 0.9em;
}

.example-note {
    font-size: 0.85em;
    color: #6c757d;
    display: flex;
    align-items: center;
    gap: 5px;
}

.example-note i {
    color: #17a2b8;
}

/* Next step note */
.next-step-note {
    background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
    color: white;
    border-radius: 8px;
    padding: 15px;
    margin-top: 20px;
}

.note-content {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 500;
}

.note-content i {
    background: rgba(255, 255, 255, 0.2);
    padding: 8px;
    border-radius: 50%;
}

/* Navigation */
.navigation-actions {
    margin-top: 30px;
    display: flex;
    gap: 15px;
    justify-content: center;
}

.navigation-actions .btn-primary {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    border: none;
    padding: 12px 24px;
    color: white;
    text-decoration: none;
    border-radius: 6px;
    font-weight: 500;
    transition: transform 0.2s;
}

.navigation-actions .btn-primary:hover {
    transform: translateY(-1px);
}

.navigation-actions .btn-secondary {
    background: #6c757d;
    border: none;
    padding: 12px 24px;
    color: white;
    text-decoration: none;
    border-radius: 6px;
    font-weight: 500;
}

/* Responsive design */
@media (max-width: 768px) {
    .correlation-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
    }
    
    .pattern-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .labels-grid {
        justify-content: center;
    }
}

/* Additional styles for text and number inputs */
.text-answer, .number-answer {
    margin-top: 10px;
}

.text-answer textarea, .number-answer input {
    width: 100%;
    padding: 12px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 14px;
    resize: vertical;
    transition: border-color 0.3s ease;
}

.text-answer textarea:focus, .number-answer input:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}

/* Question card styling */
.questions-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 10px;
}

.question-card {
    background: #ffffff;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 12px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    transition: all 0.2s ease;
}

.question-card:hover {
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    border-color: #3498db;
}

.question-header {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    margin-bottom: 10px;
}

.question-number {
    background: #3498db;
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 12px;
    flex-shrink: 0;
}

.question-content {
    flex: 1;
}

.question-text {
    font-size: 14px;
    font-weight: 600;
    color: #2c3e50;
    line-height: 1.3;
    margin-bottom: 4px;
}

.category-badge {
    display: inline-block;
    padding: 4px 8px;
    font-size: 12px;
    font-weight: 500;
    border-radius: 12px;
    text-transform: capitalize;
}

.category-onset { background: #e3f2fd; color: #1976d2; }
.category-duration { background: #f3e5f5; color: #7b1fa2; }
.category-characteristics { background: #e8f5e9; color: #388e3c; }
.category-aggravating { background: #fff3e0; color: #f57c00; }
.category-relieving { background: #e0f2f1; color: #00796b; }
.category-pain { background: #ffebee; color: #d32f2f; }
.category-associated { background: #f5f5f5; color: #616161; }

/* Compact page layout overrides */
.step-container {
    padding: 15px 20px !important;
}

.step-header {
    margin-bottom: 15px !important;
}

.step-header h2 {
    font-size: 22px !important;
    margin-bottom: 8px !important;
}

.step-header p {
    font-size: 14px !important;
    margin-bottom: 10px !important;
}

.analysis-container {
    margin-top: 0 !important;
}

.analysis-section {
    margin-bottom: 15px !important;
}

.analysis-section h3 {
    font-size: 18px !important;
    margin-bottom: 8px !important;
}

.section-description {
    font-size: 13px !important;
    margin-bottom: 10px !important;
}

/* Clinical Summary Popup Styles */
.clinical-summary-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    animation: fadeIn 0.3s ease;
}

.clinical-summary-modal {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    animation: slideIn 0.3s ease;
}

.summary-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 25px;
    border-bottom: 1px solid #e9ecef;
    background: #f8f9fa;
    border-radius: 12px 12px 0 0;
}

.summary-header h3 {
    margin: 0;
    color: #2c3e50;
    display: flex;
    align-items: center;
    gap: 10px;
}

.summary-header i {
    color: #3498db;
}

.close-btn {
    background: none;
    border: none;
    font-size: 24px;
    color: #6c757d;
    cursor: pointer;
    padding: 5px;
    line-height: 1;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.close-btn:hover {
    background: #e9ecef;
    color: #495057;
}

.summary-content {
    padding: 25px;
    max-height: 60vh;
    overflow-y: auto;
}

.summary-text {
    font-size: 14px;
    line-height: 1.6;
    color: #2c3e50;
    white-space: pre-line;
}

.summary-text h1, .summary-text h2, .summary-text h3, .summary-text h4 {
    color: #3498db;
    margin-top: 20px;
    margin-bottom: 10px;
}

.summary-text h1:first-child, .summary-text h2:first-child, .summary-text h3:first-child {
    margin-top: 0;
}

.summary-text strong {
    color: #2c3e50;
}

.summary-text ul, .summary-text ol {
    margin: 10px 0;
    padding-left: 20px;
}

.summary-text li {
    margin-bottom: 5px;
}

.summary-actions {
    display: flex;
    gap: 15px;
    justify-content: flex-end;
    padding: 20px 25px;
    border-top: 1px solid #e9ecef;
    background: #f8f9fa;
}

.summary-actions .btn-secondary {
    background: #6c757d;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s ease;
}

.summary-actions .btn-secondary:hover {
    background: #5a6268;
}

.summary-actions .btn-primary {
    background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s ease;
}

.summary-actions .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from { 
        opacity: 0;
        transform: translateY(-50px);
    }
    to { 
        opacity: 1;
        transform: translateY(0);
    }
}

/* Responsive design for popup */
@media (max-width: 768px) {
    .clinical-summary-modal {
        width: 95%;
        margin: 10px;
    }
    
    .summary-header {
        padding: 15px 20px;
    }
    
    .summary-content {
        padding: 20px;
    }
    
    .summary-actions {
        padding: 15px 20px;
        flex-direction: column;
    }
    
    .summary-actions button {
        width: 100%;
    }
}
</style>
{% endblock %}